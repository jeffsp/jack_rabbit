<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Jack Rabbit: raster_example2.cc</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Jack Rabbit
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">raster_example2.cc</div>  </div>
</div><!--header-->
<div class="contents">
<p>This example uses a custom allocator in order to write a colorful display to a simulated display buffer using the raster interface: </p>
<div class="image">
<img src="raster_example2.png" alt="raster_example2.png"/>
<div class="caption">
raster example2 output</div></div>
<div class="fragment"><pre class="fragment">





<span class="preprocessor">#include &quot;<a class="code" href="raster_8h.html" title="raster container adapter">raster.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="subscript__function_8h.html" title="functions that use raster subscripts">subscript_function.h</a>&quot;</span>
<span class="preprocessor">#include &lt;algorithm&gt;</span>
<span class="preprocessor">#include &lt;boost/static_assert.hpp&gt;</span>
<span class="preprocessor">#include &lt;cmath&gt;</span>
<span class="preprocessor">#include &lt;fstream&gt;</span>
<span class="preprocessor">#include &lt;iostream&gt;</span>
<span class="preprocessor">#include &lt;string&gt;</span>
<span class="preprocessor">#include &lt;vector&gt;</span>

<span class="keyword">using namespace </span>jack_rabbit;
<span class="keyword">using namespace </span>std;

<span class="comment">// Our video display mode dimensions.</span>
<span class="keyword">const</span> <span class="keywordtype">size_t</span> WIDTH = 320;
<span class="keyword">const</span> <span class="keywordtype">size_t</span> HEIGHT = 240;

<span class="comment">// An RGB pixel</span>
<span class="keyword">struct </span>Pixel
{
    <span class="keywordtype">char</span> rgb[3];
};

<span class="comment">// Imagine that some sort of a display class, like this one,</span>
<span class="comment">// provides access to the video display buffer.  We can</span>
<span class="comment">// interface with the video buffer using a raster if we</span>
<span class="comment">// utilize a simple custom allocator, defined below.</span>
<span class="keyword">template</span> &lt;
    <span class="keywordtype">size_t</span> W,
    <span class="keywordtype">size_t</span> H
&gt;
<span class="keyword">class </span>Display
{
    <span class="keyword">public</span>:
    Display () : p_ (W * H) { }
    Pixel *Pixels () { <span class="keywordflow">return</span> &amp;p_[0]; }
    <span class="keywordtype">size_t</span> Width ()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> W; }
    <span class="keywordtype">size_t</span> Height ()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> H; }
    <span class="keyword">private</span>:
    vector&lt;Pixel&gt; p_;
};
Display&lt;WIDTH,HEIGHT&gt; display;

<span class="comment">// Our custom allocator does not allocate any memory, but</span>
<span class="comment">// instead it returns an address to the video display</span>
<span class="comment">// memory.  The container that uses this allocator might not</span>
<span class="comment">// ask for *exactly* the number of bytes specified in the</span>
<span class="comment">// raster constructor.  If this happens, allocate will fail.</span>
<span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<span class="keyword">class </span>Alloc : <span class="keyword">public</span> allocator&lt;T&gt;
{
    <span class="keyword">public</span>:
    T *allocate (<span class="keywordtype">size_t</span> n, <span class="keyword">const</span> <span class="keywordtype">void</span> *hint = 0)
    {
        <span class="keywordflow">if</span> (n != display.Width () * display.Height ())
            <span class="keywordflow">throw</span> runtime_error (<span class="stringliteral">&quot;allocate failed&quot;</span>);
        <span class="keywordflow">return</span> display.Pixels ();
    }
    <span class="keywordtype">void</span> deallocate (Pixel *p, <span class="keywordtype">size_t</span> n) { }
    <span class="keyword">private</span>:
};

<span class="comment">// Convert from YUV colorspace to RGB colorspace</span>
<span class="keyword">template</span>&lt;<span class="keyword">typename</span> Ty&gt;
<span class="keyword">inline</span> Ty YUVR (Ty y, Ty  , Ty v) { <span class="keywordflow">return</span>  y + 1.14 * v; }
<span class="keyword">template</span>&lt;<span class="keyword">typename</span> Ty&gt;
<span class="keyword">inline</span> Ty YUVG (Ty y, Ty u, Ty v) { <span class="keywordflow">return</span>  y - 0.40 * u - 0.58 * v; }
<span class="keyword">template</span>&lt;<span class="keyword">typename</span> Ty&gt;
<span class="keyword">inline</span> Ty YUVB (Ty y, Ty u, Ty  ) { <span class="keywordflow">return</span>  y + 2.03 * u; }
<span class="keyword">template</span>&lt;<span class="keyword">typename</span> Ty&gt;
<span class="keyword">inline</span> Ty CLIP (Ty x) { <span class="keywordflow">return</span> x &gt; 1.0 ? 1.0 : (x &lt; 0.0 ? 0.0 : x); }

<span class="comment">// Our subscript function object writes a chromaticity</span>
<span class="comment">// diagram of YUV values.  The diagram is white in the</span>
<span class="comment">// center and smoothly changes color from green to red, then</span>
<span class="comment">// purple, blue, and back to green as it goes around the</span>
<span class="comment">// edge of the diagram.</span>
<span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;
<span class="keyword">struct </span>Func
{
    Func (<span class="keywordtype">size_t</span> <span class="comment">/*r*/</span>, <span class="keywordtype">size_t</span> <span class="comment">/*c*/</span>) :
        MAXD (sqrt (static_cast&lt;double&gt; (CX * CX + CY * CY)))
    { }
    T operator() (<span class="keywordtype">size_t</span> r, <span class="keywordtype">size_t</span> c)
    {
        <span class="comment">// Luminance is determined by distance from center</span>
        <span class="keywordtype">double</span> dx = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span> (c) - CX;
        <span class="keywordtype">double</span> dy = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span> (r) - CY;
        <span class="keywordtype">double</span> l = 1.0 - sqrt (dx * dx + dy * dy) / MAXD;
        <span class="comment">// Color is determined by coordinate</span>
        <span class="keywordtype">double</span> v = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span> (c) / W - 0.5;
        <span class="keywordtype">double</span> u = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span> (r) / H - 0.5;
        Pixel p;
        <span class="comment">// Convert YUV to RGB</span>
        p.rgb[0] = <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span><span class="keyword">&gt;</span> (CLIP (YUVR (l, u, v)) * 255);
        p.rgb[1] = <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span><span class="keyword">&gt;</span> (CLIP (YUVG (l, u, v)) * 255);
        p.rgb[2] = <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span><span class="keyword">&gt;</span> (CLIP (YUVB (l, u, v)) * 255);
        <span class="keywordflow">return</span> p;
    }
    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> W = WIDTH;
    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> H = HEIGHT;
    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> CX = (W - 1) / 2;
    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> CY = (H - 1) / 2;
    <span class="keyword">const</span> <span class="keywordtype">double</span> MAXD;
};

<span class="comment">// PPM file writer helper</span>
<span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;
<span class="keywordtype">void</span> WritePPM (<span class="keyword">const</span> T &amp;m, ofstream &amp;ofs)
{
    <span class="comment">// Write a ppm header</span>
    ofs &lt;&lt; <span class="stringliteral">&quot;P6\n&quot;</span>
        &lt;&lt; <span class="stringliteral">&quot;# Raster Example\n&quot;</span>
        &lt;&lt; m.cols () &lt;&lt; <span class="charliteral">&#39; &#39;</span> &lt;&lt; m.rows () &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>
        &lt;&lt; <span class="stringliteral">&quot;255\n&quot;</span>;

    <span class="comment">// Write the ppm pixels</span>
    <span class="keyword">const</span> std::streamsize sz =
        <span class="keyword">static_cast&lt;</span>std::streamsize<span class="keyword">&gt;</span> (m.size () * 3);
    ofs.write (reinterpret_cast&lt;const char *&gt; (&amp;m[0]), sz);
}

<span class="keywordtype">int</span> main ()
{
    <span class="keywordflow">try</span>
    {
        BOOST_STATIC_ASSERT (<span class="keyword">sizeof</span> (Pixel) == 3);

        <span class="comment">// Access the display through a raster</span>
        <a name="_a0"></a><a class="code" href="classjack__rabbit_1_1raster.html" title="raster container adapter">raster&lt;Pixel&gt;</a> pixels (display.Height (), display.Width (), Pixel (), Alloc&lt;Pixel&gt; ());

        <span class="comment">// Note that functor expects rows X cols</span>
        <a name="_a1"></a><a class="code" href="classjack__rabbit_1_1subscript__generator.html" title="Generating subscript function.">subscript_generator&lt;Pixel,Func&gt;</a> f (display.Height (), display.Width ());

        <span class="comment">// Make a colorful display</span>
        generate (pixels.begin (), pixels.end (), f);

        <span class="comment">// Save the image to a file</span>
        <span class="keyword">const</span> <span class="keywordtype">string</span> fn (<span class="stringliteral">&quot;raster_example2.ppm&quot;</span>);
        clog &lt;&lt; <span class="stringliteral">&quot;Writing image to &quot;</span> &lt;&lt; fn &lt;&lt; <span class="stringliteral">&quot;...&quot;</span> &lt;&lt; endl;

        ofstream ofs (fn.c_str ());
        <span class="keywordflow">if</span> (!ofs)
            <span class="keywordflow">throw</span> std::runtime_error (<span class="stringliteral">&quot;Could not open file for writing&quot;</span>);

        WritePPM (pixels, ofs);

        <span class="keywordflow">return</span> 0;
    }
    <span class="keywordflow">catch</span> (<span class="keyword">const</span> exception &amp;e)
    {
        cerr &lt;&lt; e.what () &lt;&lt; endl;
        <span class="keywordflow">return</span> -1;
    }
}
</pre></div> </div><!-- contents -->
</div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Thu May 22 2014 20:57:31 for Jack Rabbit by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
